<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

<style>
   h2, h3 { text-align : center; }
   h3 { margin-top : 30px; }
   #container {
      display : flex;
      justify-content : space-around;
   }
   #box1 { 
      width : 50%;
      border : 2px solid black;
      border-radius : 10px;
      padding : 10px;
    }
   #box2 { 
      width : 30%;
      border : 2px solid black;
      border-radius : 10px;
      padding : 10px;
    }
    
    tr{ background:''; }
    tr:hover td{ background: aqua; }
</style>

<title>Insert title here</title>
</head>
<body>
   <h2 class="bg-primary text-white fw-bold 4">Article Rest Api Test</h2>
   <div id="container">  
      <div id="box1">
         <form>
           <div class="row mb-3">
             <label for="id" class="col-form-label col-sm-2">아이디</label>
             <div class="col-sm-10">
                <input type="text" class="form-control" id="id">
             </div>
           </div>
           <div class="row mb-3">
             <label for="title" class="col-form-label col-sm-2">제목</label>
             <div class="col-sm-10">
                <input type="text" class="form-control" id="title">
             </div>
           </div>
           <div class="mb-3">
             <label for="content" class="col-form-label col-sm-2">내용</label>
             <textarea class="form-control" id="content" rows="4" style="width:100%" ></textarea>
           </div>
         </form>
      </div>
   
      <div id="box2" class="list-group">
         <a href="/api/articles"  id="getlist" 
         class="list-group-item list-group-item-action" aria-current="true">
          목록 조회
         </a>                                                                 <!-- action : 누를때 깜빡 -->
         <a id="get" href="/api/articles/2"
          class="list-group-item list-group-item-action">
          한개 조회
         </a>
         <a id="post" href="/api/articles" 
         class="list-group-item list-group-item-action">
          추가
         </a>
         <a id="patch" href="/api/articles/2" 
         class="list-group-item list-group-item-action">
          수정
         </a>
         <a id="delete" href="/api/articles/2" 
         class="list-group-item list-group-item-action" tabindex="-1" aria-disabled="false">
         삭제
         </a>
      </div>
   </div>
   
   <h3 class="bg-secondary text-white border-bottom pb-2">결과</h3>
   <div id="result" style="margin-bottom:150px"></div>
   
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
   
   <script>
      function makeTable( list ) {
         console.log(`두번째 : ${list[0].id}`)
         let table = '<table class="table table-striped mx-auto" style="width:90%">'
         table    += '<tr class="table-dark">'
         table    += `<th>#</th>`
         table    += `<th>Title</th>`
         table    += `<th>Content</th>`
         table    += '</tr>'
         
         list.forEach( (article) => {
            console.log(`세번째 : ${article.id}`)
            table  += `<tr>
            <td>${article.id}</td>
            <td>${article.title}</td>
            <td>${article.content}</td>
            </tr>`
         } )        
         table    +=   '</table>'
         return table;
      }
      
      function activeClear(aEls) {
         aEls.forEach( (aEl) => {
            aEl.classList.remove('active')   
         } )
      }
      
      function textClear(){
    	  let els = document.querySelectorAll('[class="form-control"]');
    	  els.forEach((el) => {
    		  el.value = '';
    	  })
      }
   </script>
   
   <script>
      // a Tag 클릭시 동작
      const aEls = document.querySelectorAll('a') // a tag 배열 리턴
      const resultEl = document.querySelector('#result')
      const idEl = document.querySelector('#id')
      const id2El = document.querySelector('#id2')
      const titleEl = document.querySelector('#title')
      const contentEl = document.querySelector('#content')
      
      aEls.forEach( (a) => {
         a.addEventListener('click', (e) => {
            
            activeClear(aEls)
            a.classList.add('active')
            
            e.preventDefault();
            e.stopPropagation();
            
            let id = a.id;
            let url = a.href;
      //   alert(a.innerHTML)
            switch(a.id) {
            case 'getlist' : // 목록 조회
               // api controller 실행데이터 받아온다(fetch)
               fetch(a.href)
                  .then( (response) => response.json() )
                  .then( (list) => {                      
                     console.log("첫list : ", JSON.stringify(list)) // json형식
                     console.log("첫list : ", list)                 // 객체 본연 형식
                     console.log(`첫list : ${list}`)                // `${}`객체를 toString형식
                     resultEl.innerHTML = makeTable(list);                      
                  } )
                  .then( (error) => console.log(error) )
               break;
            
            case 'post' : // 추가
              if( titleEl.value.trim() == '' ) { 
                 alert('제목을 입력하세요')
                 break; 
              }
              fetch(url, {
	              method: 'POST',
	              body: JSON.stringify({ // 서버로 data 를 보낼때 json 문자열로 보내야 한다
	                title   : titleEl.value,
	                content : contentEl.value
	              }),
	              headers: {
	                'Content-type': 'application/json; charset=UTF-8',
	              },
	            })
             .then((response) => response.json())
             .then((json) => {
                //console.log(json);
                textClear();
                aEls[0].click();
               }) // 추가완료
             .then((error) => console.log(error));
             break;
            } //switch end
         }) // end of addEventListener        
      } ) // end of aEls.forEach
      
      // #result 안에 tr을 클릭하면 undefined error
      // js 동적 생성 이벤트 호출
      // 해결책은 조상 Element에 이벤트를 등록한다.
      const divEl = document.querySelector('#result');
      
      //console.log(divEl)
      divEl.ondblclick = function(e){
    	  //console.dir(e) // e.target === td
    	  let tr = e.target.parentNode
    	  let tds = tr.childNodes
    	  
    	  console.log(tds);
    	  idEl.value = tds[0].innerHTML
    	  titleEl.value = tds[1].innerHTML
    	  contentEl.value = tds[2].innerHTML
      }
      
   </script>
   
</body>
</html>